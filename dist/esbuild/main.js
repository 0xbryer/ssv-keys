"use strict";(()=>{var ze=Object.create;var F=Object.defineProperty,Je=Object.defineProperties,Re=Object.getOwnPropertyDescriptor,We=Object.getOwnPropertyDescriptors,qe=Object.getOwnPropertyNames,_e=Object.getOwnPropertySymbols,Ge=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty,Qe=Object.prototype.propertyIsEnumerable;var ke=(s,e,r)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r,ue=(s,e)=>{for(var r in e||(e={}))Te.call(e,r)&&ke(s,r,e[r]);if(_e)for(var r of _e(e))Qe.call(e,r)&&ke(s,r,e[r]);return s},he=(s,e)=>Je(s,We(e));var o=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,r)=>(typeof require!="undefined"?require:e)[r]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var Ze=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of qe(e))!Te.call(s,i)&&i!==r&&F(s,i,{get:()=>e[i],enumerable:!(t=Re(e,i))||t.enumerable});return s};var I=(s,e,r)=>(r=s!=null?ze(Ge(s)):{},Ze(e||!s||!s.__esModule?F(r,"default",{value:s,enumerable:!0}):r,s));var c=(s,e,r,t)=>{for(var i=t>1?void 0:t?Re(e,r):e,a=s.length-1,n;a>=0;a--)(n=s[a])&&(i=(t?n(e,r,i):n(i))||i);return t&&i&&F(e,r,i),i};var y=(s,e,r)=>new Promise((t,i)=>{var a=p=>{try{l(r.next(p))}catch(h){i(h)}},n=p=>{try{l(r.throw(p))}catch(h){i(h)}},l=p=>p.done?t(p.value):Promise.resolve(p.value).then(a,n);l((r=r.apply(s,e)).next())});var $e=I(o("atob"));var me;try{window.crypto,me=o("bls-eth-wasm/browser")}catch(s){me=o("bls-eth-wasm")}var u=me;var we=o("js-base64");var m=o("class-validator");var Xe=I(o("underscore")),d=o("class-validator");var f=o("class-validator");var q=o("class-validator");var Ve=o("js-base64");var de;try{window.crypto,de=o("jsencrypt").JSEncrypt}catch(s){de=o("node-jsencrypt")}var $=de;var M=o("js-base64");var O=class extends Error{constructor(r,t){super(t);this.operator=r}},v=class{constructor(e,r){this.RAW_OPERATOR_PUBLIC_KEY_SIGNATURE=RegExp(/------BEGIN RSA PUBLIC KEY-----/,"gmi");this.operators=e.map(t=>this.RAW_OPERATOR_PUBLIC_KEY_SIGNATURE.test(t)?t:(0,M.decode)(t)),this.shares=r}encrypt(){let e=[];return Object.keys(this.operators).forEach(r=>{let t=new $({});try{t.setPublicKey(this.operators[r])}catch(n){throw new O({rsa:this.operators[r],base64:(0,M.encode)(this.operators[r])},`Operator is not valid RSA Public Key: ${n}`)}let i=t.encrypt(this.shares[r].privateKey),a={operatorPublicKey:this.operators[r],privateKey:String(i),publicKey:this.shares[r].publicKey};return e.push(a),a}),e}};var Ne=s=>{try{let e="Invalid operator key format, make sure the operator exists in the network",r=(0,Ve.decode)(s);if(s.length<98)throw Error("The length of the operator public key must be at least 98 characters.");if(!r.startsWith("-----BEGIN RSA PUBLIC KEY-----"))throw Error(e);let t=new $({});try{t.setPublicKey(r)}catch(i){throw new O({rsa:r,base64:s},e)}return!0}catch(e){let{message:r}=e;return r}};var z=class extends Error{constructor(r,t){super(t);this.operator=r}},J=class extends Error{constructor(r,t){super(t);this.operator=r}},N=class extends Error{constructor(r,t,i){super(i);this.listOne=r,this.listTwo=t}},W=class extends Error{constructor(r,t){super(t);this.publicKey=r}};var L=class{validate(e){let r=Ne(e);if(r!==!0)throw new W(e,`${r}`);return!0}defaultMessage(){return"Invalid operator public key"}};L=c([(0,q.ValidatorConstraint)({name:"operatorPublicKey",async:!1})],L);function Le(s){return function(e,r){(0,q.registerDecorator)({target:e.constructor,propertyName:r,options:s,constraints:[],validator:L})}}var _=class{setData(e){e.id&&(this.id=e.id),e.publicKey&&(this.publicKey=e.publicKey)}validate(){(0,f.validateSync)(this)}};c([(0,f.IsNotEmpty)({message:"The operator id is null"}),(0,f.IsDefined)({message:"The operator id is undefined"}),(0,f.IsInt)({message:"The operator id must be an integer"})],_.prototype,"id",2),c([(0,f.IsNotEmpty)({message:"The operator public key is null"}),(0,f.IsDefined)({message:"The operator public key is undefined"}),(0,f.IsString)({message:"The operator public key must be a string"}),Le()],_.prototype,"publicKey",2);var E=o("class-validator");var G=o("class-validator");var B=class{validate(e,r){let[t,i]=r.constraints,a=r.object[t].length;if(!Array.isArray(e))Object.values(e).forEach(n=>{if(a!==n.length)throw new N(r.object[t],e,i.message)});else if(a!==e.length)throw new N(r.object[t],e,i.message);return!0}defaultMessage(){return"The length of the entries lists are not equal"}};B=c([(0,G.ValidatorConstraint)({name:"matchLength",async:!1})],B);function Q(s,e){return function(r,t){(0,G.registerDecorator)({target:r.constructor,propertyName:t,options:e,constraints:[s,e],validator:B})}}var ee=o("class-validator");var Z=class extends Error{constructor(r,t){super(t);this.publicKey=r}};var Y=class{validate(e){return y(this,null,function*(){try{yield u.init(u.BLS12_381),typeof e=="string"?u.deserializeHexStrToPublicKey(e.replace("0x","")):e.forEach(r=>u.deserializeHexStrToPublicKey(r.replace("0x","")))}catch(r){throw new Z(e,"Failed to BLS deserialize validator public key")}return!0})}defaultMessage(){return"Invalid public key"}};Y=c([(0,ee.ValidatorConstraint)({name:"publicKey",async:!0})],Y);function re(s){return function(e,r){(0,ee.registerDecorator)({target:e.constructor,propertyName:r,options:s,constraints:[],validator:Y})}}var te=o("class-validator"),Ue=o("js-base64");var Be=I(o("web3")),k=new Be.default,Ye=(s,e)=>s.map(r=>{let t=e?Object(r)[e]:r;return String(t).startsWith("0x")?t:k.eth.abi.encodeParameter("string",t)});var U=class{validate(e){let r="";try{(Array.isArray(e)?e:[e]).forEach(i=>{r=i,(0,Ue.decode)(i.startsWith("0x")?k.eth.abi.decodeParameter("string",i):i)})}catch(t){throw Error(`Filed ABI decode shares encrypted key: ${r}. Error: ${t.message}`)}return!0}defaultMessage(){return"Filed ABI decode shares encrypted key"}};U=c([(0,te.ValidatorConstraint)({name:"encryptedKey",async:!1})],U);function Ce(s){return function(e,r){(0,te.registerDecorator)({target:e.constructor,propertyName:r,options:s,constraints:[],validator:U})}}var R=class{setData(e){e.publicKeys&&(this.publicKeys=e.publicKeys),e.encryptedKeys&&(this.encryptedKeys=e.encryptedKeys)}validate(){(0,E.validateSync)(this)}};c([(0,E.IsArray)(),(0,E.MinLength)(98,{each:!0}),re({each:!0})],R.prototype,"publicKeys",2),c([(0,E.IsArray)(),(0,E.MinLength)(98,{each:!0}),Q("publicKeys",{message:"Length of encrypted and public keys should be equal."}),Ce()],R.prototype,"encryptedKeys",2);var se=o("class-validator");var C=class{validate(e){let r=new Set,t=new Set;for(let i of e||[]){if(r.has(i.id))throw new z(i,"Operator ID already exists");if(r.add(i.id),t.has(i.publicKey))throw new J(i,"Operator public key already exists");t.add(i.publicKey)}return!0}defaultMessage(){return"The list of operators contains duplicate entries"}};C=c([(0,se.ValidatorConstraint)({name:"uniqueList",async:!1})],C);function He(s){return function(e,r){(0,se.registerDecorator)({target:e.constructor,propertyName:r,options:s,constraints:[],validator:C})}}var K=class{constructor(){this.publicKey=null;this.operators=null;this.shares=null}setData(e){if(e.publicKey&&(this.publicKey=e.publicKey),e.operators&&(this.operators=e.operators.map(r=>{let t=new _;return t.setData(r),t})),e.encryptedShares){let r=new R;Xe.default.isArray(e.encryptedShares)?r.setData({publicKeys:e.encryptedShares.map(t=>t.publicKey),encryptedKeys:e.encryptedShares.map(t=>t.privateKey)}):r.setData(e.encryptedShares),this.shares=r}}validate(){return y(this,null,function*(){(0,d.validateSync)(this)})}get sharesPublicKeys(){var e;return((e=this.shares)==null?void 0:e.publicKeys)||[]}get sharesEncryptedKeys(){var e;return((e=this.shares)==null?void 0:e.encryptedKeys)||[]}get operatorIds(){var e;return(e=this.operators)!=null&&e.length?this.operators.map(r=>parseInt(String(r.id),10)):[]}get operatorPublicKeys(){var e;return(e=this.operators)!=null&&e.length?this.operators.map(r=>String(r.publicKey)):[]}};c([(0,d.IsOptional)(),(0,d.IsString)(),(0,d.Length)(98,98),re()],K.prototype,"publicKey",2),c([(0,d.IsOptional)(),(0,d.ValidateNested)({each:!0}),He()],K.prototype,"operators",2),c([(0,d.IsOptional)(),(0,d.ValidateNested)(),Q("operators",{message:"Length of operators and shares should be equal."})],K.prototype,"shares",2);var fe=I(o("underscore"));var x=o("class-validator");var w=class{constructor(){this.readable=null;this.raw=null}build(e){return[e.publicKey,e.operatorIds.join(","),e.encryptedShares.map(r=>r.publicKey),Ye(e.encryptedShares,"privateKey"),e.amount]}setData(e){if(!e===null){this.raw=null,this.readable=null;return}if(fe.default.isArray(e)){this.raw=this.toRaw(e),this.readable=this.toReadable(e);return}fe.default.isObject(e)&&(e.readable&&(this.readable=e.readable),e.raw&&(this.raw=e.raw))}toRaw(e){return e.join(",")}toReadable(e){return{publicKey:e[w.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY],operatorIds:e[w.PAYLOAD_INDEX_OPERATOR_IDS],sharePublicKeys:e[w.PAYLOAD_INDEX_SHARE_PUBLIC_KEYS],sharePrivateKey:e[w.PAYLOAD_INDEX_SHARE_PRIVATE_KEYS],amount:e[w.PAYLOAD_INDEX_SSV_AMOUNT]}}validate(){return y(this,null,function*(){})}},g=w;g.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY=0,g.PAYLOAD_INDEX_OPERATOR_IDS=1,g.PAYLOAD_INDEX_SHARE_PUBLIC_KEYS=2,g.PAYLOAD_INDEX_SHARE_PRIVATE_KEYS=3,g.PAYLOAD_INDEX_SSV_AMOUNT=4,c([(0,x.IsOptional)(),(0,x.IsObject)()],g.prototype,"readable",2),c([(0,x.IsOptional)(),(0,x.IsString)()],g.prototype,"raw",2);var ie=class extends K{};var ge=I(o("underscore")),ae=I(o("ethers")),A=o("class-validator");var P=class{constructor(){this.readable=null;this.raw=null}decodeRSAShares(e){return e.map(r=>"0x"+Buffer.from(r,"base64").toString("hex"))}sharesToBytes(e,r){let t=this.decodeRSAShares(r),i=new Uint8Array(e.map(h=>[...ae.utils.arrayify(h)]).flat()),a=new Uint8Array(t.map(h=>[...ae.utils.arrayify(h)]).flat()),n=ae.utils.hexlify(i),l=String(n.length.toString(16)).padStart(4,"0"),p=Buffer.concat([i,a]);return`0x${l}${p.toString("hex")}`}build(e){return[e.publicKey,e.operatorIds.join(","),this.sharesToBytes(e.encryptedShares.map(r=>r.publicKey),e.encryptedShares.map(r=>r.privateKey)),e.amount,e.cluster]}setData(e){if(!e===null){this.raw=null,this.readable=null;return}if(ge.default.isArray(e)){this.raw=this.toRaw(e),this.readable=this.toReadable(e);return}ge.default.isObject(e)&&(e.readable&&(this.readable=e.readable),e.raw&&(this.raw=e.raw))}toRaw(e){return e.join(",")}toReadable(e){return{publicKey:e[P.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY],operatorIds:e[P.PAYLOAD_INDEX_OPERATOR_IDS],shares:e[P.PAYLOAD_INDEX_SHARES_KEYS],amount:e[P.PAYLOAD_INDEX_SSV_AMOUNT],cluster:e[P.PAYLOAD_INDEX_CLUSTER]}}validate(){}},b=P;b.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY=0,b.PAYLOAD_INDEX_OPERATOR_IDS=1,b.PAYLOAD_INDEX_SHARES_KEYS=2,b.PAYLOAD_INDEX_SSV_AMOUNT=3,b.PAYLOAD_INDEX_CLUSTER=4,c([(0,A.IsOptional)(),(0,A.IsObject)()],b.prototype,"readable",2),c([(0,A.IsOptional)(),(0,A.IsString)()],b.prototype,"raw",2);var T=class{constructor({version:e}){this.byVersion={payload:{[T.VERSION_V2]:g,[T.VERSION_V3]:b},data:{[T.VERSION_V2]:K,[T.VERSION_V3]:ie}};this.version=e,this.data=this.getByVersion("data",e),this.payload=this.getByVersion("payload",e)}generateContractPayload(e){var t;let r=this.payload.build(e);return(t=this.payload)==null||t.setData(r),this.payload}setData(e){!e||(this.data.setData(e),this.validate())}getByVersion(e,r){if(!this.byVersion[e])throw Error(`"${e}" is unknown entity`);if(!this.byVersion[e][r])throw Error(`"${e}" is not supported in version of key shares: ${r}`);return new this.byVersion[e][r]}validate(){(0,m.validateSync)(this)}fromJson(e){return typeof e=="string"&&(e=JSON.parse(e)),this.setData(e.data),this}toJson(){return JSON.stringify({version:this.version,data:this.data||null,payload:this.payload||null,createdAt:new Date().toISOString()},null,"  ")}},S=T;S.VERSION_V2="v2",S.VERSION_V3="v3",c([(0,m.IsString)(),(0,m.IsDefined)(),(0,m.IsNotEmpty)()],S.prototype,"version",2),c([(0,m.IsOptional)(),(0,m.ValidateNested)()],S.prototype,"data",2),c([(0,m.IsOptional)(),(0,m.ValidateNested)()],S.prototype,"payload",2);var be=class extends Error{constructor(r,t){super(t);this.operators=r}},Se=class extends Error{constructor(r,t){super(t);this.operator=r}},Ke=class{constructor(){this.shares=[]}static get DEFAULT_THRESHOLD_NUMBER(){return 3}create(e,r){return y(this,null,function*(){r.map(l=>{if(!Number.isInteger(l))throw new Se(l,`Operator must be integer. Got: ${String(l)}`)});let t=(r.length-1)/3;if(!Number.isInteger(t))throw new be(r,"Invalid operators length. It should satisfy conditions: \u2016 Operators \u2016 := 3 * F + 1 ; F \u2208 \u2115");yield u.init(u.BLS12_381);let i=[],a=[];this.privateKey=u.deserializeHexStrToSecretKey(e),this.publicKey=this.privateKey.getPublicKey(),i.push(this.privateKey),a.push(this.publicKey);for(let l=1;l<r.length-t;l+=1){let p=new u.SecretKey;p.setByCSPRNG(),i.push(p);let h=p.getPublicKey();a.push(h)}for(let l of r){let p=new u.Id;p.setInt(l);let h=new u.SecretKey;h.share(i,p);let D=new u.PublicKey;D.share(a,p),this.shares.push({privateKey:`0x${h.serializeToHexStr()}`,publicKey:`0x${D.serializeToHexStr()}`,id:p})}return{privateKey:`0x${this.privateKey.serializeToHexStr()}`,publicKey:`0x${this.publicKey.serializeToHexStr()}`,shares:this.shares}})}},ne=Ke;var Ie=I(o("crypto")),je=o("scrypt-js"),oe=I(o("ethereumjs-wallet")),ce=o("ethereumjs-util");var Ee=class{constructor(e){this.privateKey="";if(!e)throw new Error("Key store data should be JSON or string");if(typeof e=="string"?this.keyStoreData=JSON.parse(e):this.keyStoreData=e,!this.keyStoreData.version)throw new Error("Invalid keystore file")}getPublicKey(){var e;if(this.keyStoreData)switch((e=this.keyStoreData.version)!=null?e:this.keyStoreData.Version){case 1:return this.keyStoreData.Address;case 3:return this.keyStoreData.id;case 4:return this.keyStoreData.pubkey}return""}getPrivateKey(e=""){return y(this,null,function*(){if(this.privateKey)return this.privateKey;switch(this.keyStoreData.version){case 1:this.wallet=yield oe.default.fromV1(this.keyStoreData,e);break;case 3:this.wallet=yield oe.default.fromV3(this.keyStoreData,e,!0);break;case 4:this.wallet=yield this.fromV4(this.keyStoreData,e);break}if(this.wallet&&(this.privateKey=this.wallet.getPrivateKey().toString("hex"),!this.privateKey))throw new Error("Invalid password");return this.privateKey})}fromV4(e,r){return y(this,null,function*(){let t=typeof e=="object"?e:JSON.parse(e);if(t.version!==4)throw new Error("Not a V4 wallet");let i,a;if(t.crypto.kdf.function==="scrypt")a=t.crypto.kdf.params,i=(0,je.syncScrypt)(Buffer.from(r),Buffer.from(a.salt,"hex"),a.n,a.r,a.p,a.dklen);else if(t.crypto.kdf.function==="pbkdf2"){if(a=t.crypto.kdf.params,a.prf!=="hmac-sha256")throw new Error("Unsupported parameters to PBKDF2");i=Ie.default.pbkdf2Sync(Buffer.from(r),Buffer.from(a.salt,"hex"),a.c,a.dklen,"sha256")}else throw new Error("Unsupported key derivation scheme");let n=Buffer.from(t.crypto.cipher.message,"hex"),l=Buffer.concat([Buffer.from(i.slice(16,32)),n]),h={keccak256:ce.keccak256,sha256:ce.sha256}[t.crypto.checksum.function];if(h(l).toString("hex")!==t.crypto.checksum.message)throw new Error("Invalid password");let X=Ie.default.createDecipheriv(t.crypto.cipher.function,i.slice(0,16),Buffer.from(t.crypto.cipher.params.iv,"hex")),j=this.runCipherBuffer(X,n);return new oe.default(j)})}runCipherBuffer(e,r){return Buffer.concat([e.update(r),e.final()])}static toHexString(e){return Array.from(e,r=>`0${(r&255).toString(16)}`.slice(-2)).join("")}},pe=Ee;var Fe=o("cluster-scanner");var V=class{static get(e){return y(this,null,function*(){return(yield new Fe.SSVScannerCommand(e).scan()).payload.Data})}};var le=class{constructor(e){if(!Object.values(le.VERSION).includes(e))throw Error("Version is not supported");this.version=e,this.keySharesInstance=new S({version:this.version})}get keyShares(){return this.keySharesInstance}getPrivateKeyFromKeystoreData(e,r){return y(this,null,function*(){try{let t=yield new pe(e).getPrivateKey(r);return yield u.init(u.BLS12_381),this.privateKey=`0x${u.deserializeHexStrToSecretKey(t).serializeToHexStr()}`,this.publicKey=`0x${u.deserializeHexStrToSecretKey(t).getPublicKey().serializeToHexStr()}`,t}catch(t){return t}})}createThreshold(e,r){return y(this,null,function*(){return this.threshold=yield new ne().create(e,r),this.threshold})}encryptShares(e,r,t=""){return y(this,null,function*(){try{let i=e.map(n=>String((0,we.encode)((0,$e.default)(n))));return new v(i,r).encrypt().map(n=>(n.operatorPublicKey=(0,we.encode)(n.operatorPublicKey),t===le.SHARES_FORMAT_ABI&&(n.operatorPublicKey=k.eth.abi.encodeParameter("string",n.operatorPublicKey),n.privateKey=k.eth.abi.encodeParameter("string",n.privateKey)),n))}catch(i){return i}})}buildShares(e,r,t){return y(this,null,function*(){let i=yield this.createThreshold(e,r);return this.encryptShares(t,i.shares)})}getThreshold(){return this.threshold}buildPayload(e,r){return y(this,null,function*(){let t=yield V.get(he(ue({},r),{operatorIds:e.operatorIds}));return this.keyShares.generateContractPayload({publicKey:e.publicKey,operatorIds:e.operatorIds,encryptedShares:e.encryptedShares,amount:e.amount,cluster:t})})}buildPayloadFromKeyShares(e,r,t){return y(this,null,function*(){var D,X,j,xe,Pe,Ae,De,Oe,ve;let i=((X=(D=e.data)==null?void 0:D.shares)==null?void 0:X.publicKeys)||[],a=(j=e.data)==null?void 0:j.publicKey,n=((Pe=(xe=e.data)==null?void 0:xe.shares)==null?void 0:Pe.encryptedKeys)||[],l=((Ae=e.data)==null?void 0:Ae.operatorPublicKeys)||[],p=(De=e.data.operators)==null?void 0:De.map(ye=>ye.id);if(i.length!==n.length||i.length!==l.length||n.length!==l.length||!n.length||!l.length||!i.length)throw Error("Operator public keys and shares public/encrypted keys length does not match or have zero length.");let h=yield V.get(he(ue({},t),{operatorIds:p}));return this.keyShares.generateContractPayload({publicKey:a,operatorIds:p,encryptedShares:i.map((ye,Me)=>({publicKey:ye,privateKey:n[Me]})),amount:r||((ve=(Oe=e.payload)==null?void 0:Oe.readable)==null?void 0:ve.amount)||0,cluster:h})})}},H=le;H.SHARES_FORMAT_ABI="abi",H.VERSION={V2:"v2",V3:"v3"};})();
