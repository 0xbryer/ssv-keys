"use strict";(()=>{var yr=Object.create;var O=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var pr=Object.getOwnPropertyNames,q=Object.getOwnPropertySymbols,lr=Object.getPrototypeOf,rr=Object.prototype.hasOwnProperty,ur=Object.prototype.propertyIsEnumerable;var Q=(i,r,e)=>r in i?O(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e,D=(i,r)=>{for(var e in r||(r={}))rr.call(r,e)&&Q(i,e,r[e]);if(q)for(var e of q(r))ur.call(r,e)&&Q(i,e,r[e]);return i};var c=(i=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(i,{get:(r,e)=>(typeof require!="undefined"?require:r)[e]}):i)(function(i){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+i+'" is not supported')});var dr=(i,r)=>{for(var e in r)O(i,e,{get:r[e],enumerable:!0})},fr=(i,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of pr(r))!rr.call(i,s)&&s!==e&&O(i,s,{get:()=>r[s],enumerable:!(t=Z(r,s))||t.enumerable});return i};var v=(i,r,e)=>(e=i!=null?yr(lr(i)):{},fr(r||!i||!i.__esModule?O(e,"default",{value:i,enumerable:!0}):e,i));var y=(i,r,e,t)=>{for(var s=t>1?void 0:t?Z(r,e):r,n=i.length-1,a;n>=0;n--)(a=i[n])&&(s=(t?a(r,e,s):a(s))||s);return t&&s&&O(r,e,s),s};var o=(i,r,e)=>new Promise((t,s)=>{var n=l=>{try{p(e.next(l))}catch(u){s(u)}},a=l=>{try{p(e.throw(l))}catch(u){s(u)}},p=l=>l.done?t(l.value):Promise.resolve(l.value).then(n,a);p((e=e.apply(i,r)).next())});var er=v(c("atob")),tr=v(c("web3")),W=c("js-base64"),sr=v(c("eth2-keystore-js"));var V;try{window.crypto,V=c("bls-eth-wasm/browser")}catch(i){V=c("bls-eth-wasm")}var d=V;var Y=class extends Error{constructor(e,t){super(t);this.operators=e}},J=class extends Error{constructor(e,t){super(t);this.operator=e}},$=class{constructor(){this.shares=[]}static get DEFAULT_THRESHOLD_NUMBER(){return 3}create(r,e){return o(this,null,function*(){e.map(s=>{if(!Number.isInteger(s))throw new J(s,`Operator must be integer. Got: ${String(s)}`)});let t=(e.length-1)/3;if(!Number.isInteger(t))throw new Y(e,"Invalid operators length. It should satisfy conditions: \u2016 Operators \u2016 := 3 * F + 1 ; F \u2208 \u2115");return new Promise((s,n)=>{try{d.init(d.BLS12_381).then(()=>{let a=[],p=[];this.validatorPrivateKey=d.deserializeHexStrToSecretKey(r),this.validatorPublicKey=this.validatorPrivateKey.getPublicKey(),a.push(this.validatorPrivateKey),p.push(this.validatorPublicKey);for(let u=1;u<e.length-t;u+=1){let f=new d.SecretKey;f.setByCSPRNG(),a.push(f);let K=f.getPublicKey();p.push(K)}for(let u of e){let f=new d.Id;f.setInt(u);let K=new d.SecretKey;K.share(a,f);let P=new d.PublicKey;P.share(p,f),this.shares.push({privateKey:`0x${K.serializeToHexStr()}`,publicKey:`0x${P.serializeToHexStr()}`,id:f})}let l={validatorPrivateKey:`0x${this.validatorPrivateKey.serializeToHexStr()}`,validatorPublicKey:`0x${this.validatorPublicKey.serializeToHexStr()}`,shares:this.shares};s(l)})}catch(a){n(a)}})})}},k=$;var N=c("js-base64");var C;try{window.crypto,C=c("jsencrypt").JSEncrypt}catch(i){C=c("node-jsencrypt")}var _=C;var w=class extends Error{constructor(e,t){super(t);this.operator=e}},E=class{constructor(r,e){this.RAW_OPERATOR_PUBLIC_KEY_SIGNATURE=RegExp(/------BEGIN RSA PUBLIC KEY-----/,"gmi");this.operators=r.map(t=>this.RAW_OPERATOR_PUBLIC_KEY_SIGNATURE.test(t)?t:(0,N.decode)(t)),this.shares=e}encrypt(){let r=[];return Object.keys(this.operators).forEach(e=>{let t=new _({});try{t.setPublicKey(this.operators[e])}catch(a){throw new w({rsa:this.operators[e],base64:(0,N.encode)(this.operators[e])},`Operator is not valid RSA Public Key: ${a}`)}let s=t.encrypt(this.shares[e].privateKey),n={operatorPublicKey:this.operators[e],privateKey:String(s),publicKey:this.shares[e].publicKey};return r.push(n),n}),r}};var H=class{constructor(){this.web3Instances={}}getWeb3(r=process.env.NODE_URL||""){return this.web3Instances[r]||(this.web3Instances[r]=new tr.default(String(r||""))),this.web3Instances[r]}getPrivateKeyFromKeystoreData(r,e){return o(this,null,function*(){try{try{r=JSON.parse(r)}catch(s){}return yield new sr.default(r).getPrivateKey(e).then(s=>s)}catch(t){return t}})}createThreshold(r,e){return o(this,null,function*(){try{let t=new k;return this.threshold=yield t.create(r,e),this.threshold}catch(t){return t}})}encryptShares(r,e,t=""){return o(this,null,function*(){try{let s=r.map(a=>String((0,W.encode)((0,er.default)(a))));return new E(s,e).encrypt().map(a=>(a.operatorPublicKey=(0,W.encode)(a.operatorPublicKey),t===H.SHARES_FORMAT_ABI&&(a.operatorPublicKey=this.getWeb3().eth.abi.encodeParameter("string",a.operatorPublicKey),a.privateKey=this.getWeb3().eth.abi.encodeParameter("string",a.privateKey)),a))}catch(s){return s}})}buildShares(r,e,t){return o(this,null,function*(){let s=yield this.createThreshold(r,e);return this.encryptShares(t,s.shares)})}getThreshold(){return this.threshold}getValidatorPublicKey(){var r;return((r=this.getThreshold())==null?void 0:r.validatorPublicKey)||""}abiEncode(r,e){return r.map(t=>{let s=e?Object(t)[e]:t;return String(s).startsWith("0x")?s:this.getWeb3().eth.abi.encodeParameter("string",s)})}buildPayload(r,e,t,s){let n=t.map(p=>p.publicKey),a=this.abiEncode(t,"privateKey");return[r,e.join(","),n,a,s]}buildPayloadFromKeyShares(r,e){var a,p,l,u,f,K,P,X,M,G;let t=((p=(a=r.data)==null?void 0:a.shares)==null?void 0:p.publicKeys)||[],s=((u=(l=r.data)==null?void 0:l.shares)==null?void 0:u.encryptedKeys)||[],n=((f=r.data)==null?void 0:f.operatorPublicKeys)||[];if(t.length!==s.length||t.length!==n.length||s.length!==n.length||!s.length||!n.length||!t.length)throw Error("Operator public keys and shares public/encrypted keys length does not match or have zero length.");return[(K=r.data)==null?void 0:K.publicKey,((X=(P=r.data)==null?void 0:P.operatorIds)==null?void 0:X.join(","))||"",t,this.abiEncode(s),e||((G=(M=r.payload)==null?void 0:M.readable)==null?void 0:G.ssvAmount)||0]}},R=H;R.SHARES_FORMAT_ABI="abi";var U=v(c("crypto")),ir=c("scrypt-js"),B=v(c("ethereumjs-wallet")),T=c("ethereumjs-util");var F=class{constructor(r){this.privateKey="";if(!r)throw new Error("Key store data should be JSON or string");if(this.keyStoreData=JSON.parse(String(r)),!this.keyStoreData.version)throw new Error("Invalid keystore file")}getPublicKey(){var r;if(this.keyStoreData)switch((r=this.keyStoreData.version)!=null?r:this.keyStoreData.Version){case 1:return this.keyStoreData.Address;case 3:return this.keyStoreData.id;case 4:return this.keyStoreData.pubkey}return""}getPrivateKey(r=""){return o(this,null,function*(){if(this.privateKey)return this.privateKey;switch(this.keyStoreData.version){case 1:this.wallet=yield B.default.fromV1(this.keyStoreData,r);break;case 3:this.wallet=yield B.default.fromV3(this.keyStoreData,r,!0);break;case 4:this.wallet=yield this.fromV4(this.keyStoreData,r);break}if(this.wallet&&(this.privateKey=this.wallet.getPrivateKey().toString("hex"),!this.privateKey))throw new Error("Invalid password");return this.privateKey})}fromV4(r,e){return o(this,null,function*(){let t=typeof r=="object"?r:JSON.parse(r);if(t.version!==4)throw new Error("Not a V4 wallet");let s,n;if(t.crypto.kdf.function==="scrypt")n=t.crypto.kdf.params,s=yield(0,ir.scrypt)(Buffer.from(e),Buffer.from(n.salt,"hex"),n.n,n.r,n.p,n.dklen);else if(t.crypto.kdf.function==="pbkdf2"){if(n=t.crypto.kdf.params,n.prf!=="hmac-sha256")throw new Error("Unsupported parameters to PBKDF2");s=U.default.pbkdf2Sync(Buffer.from(e),Buffer.from(n.salt,"hex"),n.c,n.dklen,"sha256")}else throw new Error("Unsupported key derivation scheme");let a=Buffer.from(t.crypto.cipher.message,"hex"),p=Buffer.concat([Buffer.from(s.slice(16,32)),a]),u={keccak256:T.keccak256,sha256:T.sha256}[t.crypto.checksum.function];if(u(p).toString("hex")!==t.crypto.checksum.message)throw new Error("Invalid password");let K=U.default.createDecipheriv(t.crypto.cipher.function,s.slice(0,16),Buffer.from(t.crypto.cipher.params.iv,"hex")),P=this.runCipherBuffer(K,a);return new B.default(P)})}runCipherBuffer(r,e){return Buffer.concat([r.update(e),r.final()])}static toHexString(r){return Array.from(r,e=>`0${(e&255).toString(16)}`.slice(-2)).join("")}},ar=F;var z=v(c("underscore")),g=c("class-validator");var j={};dr(j,{KeySharesDataV2:()=>S,KeySharesKeysV2:()=>I,OperatorV2:()=>x});var cr=v(c("web3")),hr=c("js-base64"),h=c("class-validator");var nr=c("js-base64");var or=i=>o(void 0,null,function*(){try{let r="Invalid operator key format, make sure the operator exists in the network",e=(0,nr.decode)(i);if(!e.startsWith("-----BEGIN RSA PUBLIC KEY-----"))throw Error(r);let t=new _({});try{t.setPublicKey(e)}catch(s){throw new w({rsa:e,base64:i},r)}return!0}catch(r){let{message:e}=r;return e}});var mr=new cr.default,I=class{constructor(r,e){this.publicKeys=r,this.encryptedKeys=e}};y([(0,h.IsArray)(),(0,h.MinLength)(98,{each:!0})],I.prototype,"publicKeys",2),y([(0,h.IsArray)(),(0,h.MinLength)(98,{each:!0})],I.prototype,"encryptedKeys",2);var x=class{constructor(r,e){this.id=r,this.publicKey=e}};y([(0,h.IsInt)()],x.prototype,"id",2),y([(0,h.IsString)(),(0,h.MinLength)(98)],x.prototype,"publicKey",2);var S=class{constructor(r){r.publicKey&&(this.publicKey=r.publicKey),r.operators&&(this.operators=r.operators.map(e=>new x(e.id,e.publicKey))),r.shares&&(this.shares=new I(r.shares.publicKeys,r.shares.encryptedKeys))}get sharesPublicKeys(){var r;return((r=this.shares)==null?void 0:r.publicKeys)||null}get sharesEncryptedKeys(){var r;return((r=this.shares)==null?void 0:r.encryptedKeys)||null}get operatorIds(){var r;return(r=this.operators)!=null&&r.length?this.operators.map(e=>e.id):null}get operatorPublicKeys(){var r;return(r=this.operators)!=null&&r.length?this.operators.map(e=>e.publicKey):null}validateValidatorPublicKey(){return o(this,null,function*(){if(!!this.publicKey)try{d.deserializeHexStrToPublicKey(this.publicKey.replace("0x",""))}catch(r){throw Error(`Can not BLS deserialize validator public key: ${this.publicKey}. Error: ${String(r)}`)}})}validateSharesPublicKeys(){return o(this,null,function*(){var e;if(!((e=this.sharesPublicKeys)!=null&&e.length))return;let r="";try{for(let t of this.sharesPublicKeys)r=t,d.deserializeHexStrToPublicKey(t.replace("0x",""))}catch(t){throw Error(`Can not BLS deserialize shares public key: ${r}. Error: ${String(t)}`)}})}validateSharesEncryptedKeys(){return o(this,null,function*(){var e;if(!((e=this.sharesEncryptedKeys)!=null&&e.length))return;let r="";try{this.sharesEncryptedKeys.map(t=>{let s=t;s.startsWith("0x")&&(r=s,s=mr.eth.abi.decodeParameter("string",t)),(0,hr.decode)(String(s))})}catch(t){throw Error(`Can not ABI decode shares encrypted key: ${r}. Error: ${String(t)}`)}})}validateCounts(){return o(this,null,function*(){var r,e,t,s,n,a;if(!(!((r=this.sharesEncryptedKeys)!=null&&r.length)||!((e=this.sharesPublicKeys)!=null&&e.length))&&(((t=this.operatorIds)==null?void 0:t.length)!==this.sharesEncryptedKeys.length||((s=this.operatorIds)==null?void 0:s.length)!==this.sharesPublicKeys.length||((n=this.operatorIds)==null?void 0:n.length)!==((a=this.operatorPublicKeys)==null?void 0:a.length)))throw Error("Length of operators and shares should be equal.")})}validateOperatorsPublicKeys(){return o(this,null,function*(){for(let r of this.operatorPublicKeys||[]){let e=yield or(r);if(e!==!0)throw Error(String(e))}})}validate(){return o(this,null,function*(){yield d.init(d.BLS12_381),yield this.validateCounts(),yield this.validateSharesPublicKeys(),yield this.validateValidatorPublicKey(),yield this.validateSharesEncryptedKeys(),yield this.validateOperatorsPublicKeys()})}};y([(0,h.IsString)(),(0,h.Length)(98,98)],S.prototype,"publicKey",2),y([(0,h.ValidateNested)()],S.prototype,"operators",2),y([(0,h.IsOptional)(),(0,h.ValidateNested)()],S.prototype,"shares",2);var L=c("class-validator");var A=class{constructor(r){this.readable={};this.raw="";this.readable=r.readable||{},this.raw=r.raw||""}validate(){return o(this,null,function*(){})}};y([(0,L.IsObject)()],A.prototype,"readable",2),y([(0,L.IsString)()],A.prototype,"raw",2);var b=class{constructor({version:r}){this.version=r}setPayload(r){return o(this,null,function*(){return r&&(this.payload=this.usePayload(r,this.version),yield this.validatePayload()),this})}setData(r){return o(this,null,function*(){return r&&(this.data=this.useData(r,this.version),yield this.validateData()),this})}static fromData(r){return o(this,null,function*(){typeof r=="string"&&(r=JSON.parse(r));let e=new b({version:r.version});return yield e.setData(r.data),yield e.setPayload(r.payload),yield e.validate(),e})}usePayload(r,e){switch(z.default.isArray(r)&&(r={readable:{validatorPublicKey:r[b.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY],operatorIds:r[b.PAYLOAD_INDEX_OPERATOR_IDS],sharePublicKeys:r[b.PAYLOAD_INDEX_SHARE_PUBLIC_KEYS],sharePrivateKey:r[b.PAYLOAD_INDEX_SHARE_PRIVATE_KEYS],ssvAmount:r[b.PAYLOAD_INDEX_SSV_AMOUNT]},raw:r.join(",")}),r=D(D({},JSON.parse(JSON.stringify(this.payload||{}))),JSON.parse(JSON.stringify(r||{}))),e){case b.VERSION_V2:return new A(r);default:throw Error(`Keyshares version is not supported: ${e}`)}}useData(r,e){switch(r=D(D({},JSON.parse(JSON.stringify(this.data||{}))),JSON.parse(JSON.stringify(r||{}))),z.default.isArray(r.shares)&&(r.shares={publicKeys:r.shares.map(t=>t.publicKey),encryptedKeys:r.shares.map(t=>t.privateKey)}),e){case b.VERSION_V2:return new S(r);default:throw Error(`Keyshares version is not supported: ${e}`)}}validate(){return o(this,null,function*(){yield(0,g.validateOrReject)(this).catch(r=>{throw Error(`Keyshares file have wrong format. Errors: ${JSON.stringify(r,null,"  ")}`)}),yield this.validateData(),yield this.validatePayload()})}validatePayload(){return o(this,null,function*(){var r;try{yield(r=this.payload)==null?void 0:r.validate()}catch(e){throw Error(`Keyshares payload did not pass validation. Errors: ${e.message||e.stack||e.trace||String(e)}`)}})}validateData(){return o(this,null,function*(){var r;try{yield(r=this.data)==null?void 0:r.validate()}catch(e){throw Error(`Keyshares data did not pass validation. Errors: ${e.message||e.stack||e.trace||String(e)}`)}})}toString(){return JSON.stringify({version:this.version,data:this.data||null,payload:this.payload||null,createdAt:new Date().toISOString()},null,"  ")}},m=b;m.VERSION_V2="v2",m.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY=0,m.PAYLOAD_INDEX_OPERATOR_IDS=1,m.PAYLOAD_INDEX_SHARE_PUBLIC_KEYS=2,m.PAYLOAD_INDEX_SHARE_PRIVATE_KEYS=3,m.PAYLOAD_INDEX_SSV_AMOUNT=4,y([(0,g.IsString)(),(0,g.IsDefined)(),(0,g.IsNotEmpty)()],m.prototype,"version",2),y([(0,g.ValidateNested)()],m.prototype,"data",2),y([(0,g.ValidateNested)()],m.prototype,"payload",2);})();
