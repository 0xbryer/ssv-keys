"use strict";(()=>{var he=Object.create;var Y=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var le=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var c=(i=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(i,{get:(e,r)=>(typeof require!="undefined"?require:e)[r]}):i)(function(i){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+i+'" is not supported')});var de=(i,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of pe(e))!ue.call(i,s)&&s!==r&&Y(i,s,{get:()=>e[s],enumerable:!(t=Q(e,s))||t.enumerable});return i};var S=(i,e,r)=>(r=i!=null?he(le(i)):{},de(e||!i||!i.__esModule?Y(r,"default",{value:i,enumerable:!0}):r,i));var y=(i,e,r,t)=>{for(var s=t>1?void 0:t?Q(e,r):e,o=i.length-1,n;o>=0;o--)(n=i[o])&&(s=(t?n(e,r,s):n(s))||s);return t&&s&&Y(e,r,s),s};var a=(i,e,r)=>new Promise((t,s)=>{var o=u=>{try{h(r.next(u))}catch(d){s(d)}},n=u=>{try{h(r.throw(u))}catch(d){s(d)}},h=u=>u.done?t(u.value):Promise.resolve(u.value).then(o,n);h((r=r.apply(i,e)).next())});var Z=S(c("atob")),ee=S(c("web3")),F=c("js-base64"),re=S(c("eth2-keystore-js"));var C;try{window.crypto,C=c("bls-eth-wasm/browser")}catch(i){C=c("bls-eth-wasm")}var p=C;var W=class extends Error{constructor(r,t){super(t);this.operators=r}},$=class extends Error{constructor(r,t){super(t);this.operator=r}},H=class{constructor(){this.shares=[]}static get DEFAULT_THRESHOLD_NUMBER(){return 3}create(e,r){return a(this,null,function*(){r.map(s=>{if(!Number.isInteger(s))throw new $(s,`Operator must be integer. Got: ${String(s)}`)});let t=(r.length-1)/3;if(!Number.isInteger(t))throw new W(r,"Invalid operators length. It should satisfy conditions: \u2016 Operators \u2016 := 3 * F + 1 ; F \u2208 \u2115");return new Promise((s,o)=>{try{p.init(p.BLS12_381).then(()=>{let n=[],h=[];this.validatorPrivateKey=p.deserializeHexStrToSecretKey(e),this.validatorPublicKey=this.validatorPrivateKey.getPublicKey(),n.push(this.validatorPrivateKey),h.push(this.validatorPublicKey);for(let d=1;d<r.length-t;d+=1){let f=new p.SecretKey;f.setByCSPRNG(),n.push(f);let K=f.getPublicKey();h.push(K)}for(let d of r){let f=new p.Id;f.setInt(d);let K=new p.SecretKey;K.share(n,f);let P=new p.PublicKey;P.share(h,f),this.shares.push({privateKey:`0x${K.serializeToHexStr()}`,publicKey:`0x${P.serializeToHexStr()}`,id:f})}let u={validatorPrivateKey:`0x${this.validatorPrivateKey.serializeToHexStr()}`,validatorPublicKey:`0x${this.validatorPublicKey.serializeToHexStr()}`,shares:this.shares};s(u)})}catch(n){o(n)}})})}},R=H;var N=c("js-base64");var U;try{window.crypto,U=c("jsencrypt").JSEncrypt}catch(i){U=c("node-jsencrypt")}var B=U;var A=class extends Error{constructor(r,t){super(t);this.operator=r}},D=class{constructor(e,r){this.RAW_OPERATOR_PUBLIC_KEY_SIGNATURE=RegExp(/------BEGIN RSA PUBLIC KEY-----/,"gmi");this.operators=e.map(t=>this.RAW_OPERATOR_PUBLIC_KEY_SIGNATURE.test(t)?t:(0,N.decode)(t)),this.shares=r}encrypt(){let e=[];return Object.keys(this.operators).forEach(r=>{let t=new B({});try{t.setPublicKey(this.operators[r])}catch(n){throw new A({rsa:this.operators[r],base64:(0,N.encode)(this.operators[r])},`Operator is not valid RSA Public Key: ${n}`)}let s=t.encrypt(this.shares[r].privateKey),o={operatorPublicKey:this.operators[r],privateKey:String(s),publicKey:this.shares[r].publicKey};return e.push(o),o}),e}};var j=class{constructor(){this.web3Instances={}}getWeb3(e=process.env.NODE_URL||""){return this.web3Instances[e]||(this.web3Instances[e]=new ee.default(String(e||""))),this.web3Instances[e]}getPrivateKeyFromKeystoreData(e,r){return a(this,null,function*(){try{try{e=JSON.parse(e)}catch(s){}return yield new re.default(e).getPrivateKey(r).then(s=>s)}catch(t){return t}})}createThreshold(e,r){return a(this,null,function*(){try{let t=new R;return this.threshold=yield t.create(e,r),this.threshold}catch(t){return t}})}encryptShares(e,r,t=""){return a(this,null,function*(){try{let s=e.map(n=>String((0,F.encode)((0,Z.default)(n))));return new D(s,r).encrypt().map(n=>(n.operatorPublicKey=(0,F.encode)(n.operatorPublicKey),t===j.SHARES_FORMAT_ABI&&(n.operatorPublicKey=this.getWeb3().eth.abi.encodeParameter("string",n.operatorPublicKey),n.privateKey=this.getWeb3().eth.abi.encodeParameter("string",n.privateKey)),n))}catch(s){return s}})}buildShares(e,r,t){return a(this,null,function*(){let s=yield this.createThreshold(e,r);return this.encryptShares(t,s.shares)})}getThreshold(){return this.threshold}getValidatorPublicKey(){var e;return((e=this.getThreshold())==null?void 0:e.validatorPublicKey)||""}abiEncode(e,r){return e.map(t=>{let s=r?Object(t)[r]:t;return String(s).startsWith("0x")?s:this.getWeb3().eth.abi.encodeParameter("string",s)})}buildPayload(e,r,t,s){let o=t.map(h=>h.publicKey),n=this.abiEncode(t,"privateKey");return[e,r.join(","),o,n,s]}buildPayloadFromKeyShares(e,r){var n,h,u,d,f,K,P,M,G,q;let t=((h=(n=e.data)==null?void 0:n.shares)==null?void 0:h.publicKeys)||[],s=((d=(u=e.data)==null?void 0:u.shares)==null?void 0:d.encryptedKeys)||[],o=((f=e.data)==null?void 0:f.operatorPublicKeys)||[];if(t.length!==s.length||t.length!==o.length||s.length!==o.length||!s.length||!o.length||!t.length)throw Error("Operator public keys and shares public/encrypted keys length does not match or have zero length.");return[(K=e.data)==null?void 0:K.publicKey,((M=(P=e.data)==null?void 0:P.operatorIds)==null?void 0:M.join(","))||"",t,this.abiEncode(s),r||((q=(G=e.payload)==null?void 0:G.readable)==null?void 0:q.ssvAmount)||0]}},L=j;L.SHARES_FORMAT_ABI="abi";var z=S(c("crypto")),te=c("scrypt-js"),T=S(c("ethereumjs-wallet")),V=c("ethereumjs-util");var J=class{constructor(e){this.privateKey="";if(!e)throw new Error("Key store data should be JSON or string");if(this.keyStoreData=JSON.parse(String(e)),!this.keyStoreData.version)throw new Error("Invalid keystore file")}getPublicKey(){var e;if(this.keyStoreData)switch((e=this.keyStoreData.version)!=null?e:this.keyStoreData.Version){case 1:return this.keyStoreData.Address;case 3:return this.keyStoreData.id;case 4:return this.keyStoreData.pubkey}return""}getPrivateKey(e=""){return a(this,null,function*(){if(this.privateKey)return this.privateKey;switch(this.keyStoreData.version){case 1:this.wallet=yield T.default.fromV1(this.keyStoreData,e);break;case 3:this.wallet=yield T.default.fromV3(this.keyStoreData,e,!0);break;case 4:this.wallet=yield this.fromV4(this.keyStoreData,e);break}if(this.wallet&&(this.privateKey=this.wallet.getPrivateKey().toString("hex"),!this.privateKey))throw new Error("Invalid password");return this.privateKey})}fromV4(e,r){return a(this,null,function*(){let t=typeof e=="object"?e:JSON.parse(e);if(t.version!==4)throw new Error("Not a V4 wallet");let s,o;if(t.crypto.kdf.function==="scrypt")o=t.crypto.kdf.params,s=yield(0,te.scrypt)(Buffer.from(r),Buffer.from(o.salt,"hex"),o.n,o.r,o.p,o.dklen);else if(t.crypto.kdf.function==="pbkdf2"){if(o=t.crypto.kdf.params,o.prf!=="hmac-sha256")throw new Error("Unsupported parameters to PBKDF2");s=z.default.pbkdf2Sync(Buffer.from(r),Buffer.from(o.salt,"hex"),o.c,o.dklen,"sha256")}else throw new Error("Unsupported key derivation scheme");let n=Buffer.from(t.crypto.cipher.message,"hex"),h=Buffer.concat([Buffer.from(s.slice(16,32)),n]),d={keccak256:V.keccak256,sha256:V.sha256}[t.crypto.checksum.function];if(d(h).toString("hex")!==t.crypto.checksum.message)throw new Error("Invalid password");let K=z.default.createDecipheriv(t.crypto.cipher.function,s.slice(0,16),Buffer.from(t.crypto.cipher.params.iv,"hex")),P=this.runCipherBuffer(K,n);return new T.default(P)})}runCipherBuffer(e,r){return Buffer.concat([e.update(r),e.final()])}static toHexString(e){return Array.from(e,r=>`0${(r&255).toString(16)}`.slice(-2)).join("")}},se=J;var l=c("class-validator");var ye=S(c("underscore")),g=c("class-validator");var m=c("class-validator");var ie=c("js-base64");var ae=i=>a(void 0,null,function*(){try{let e="Invalid operator key format, make sure the operator exists in the network",r=(0,ie.decode)(i);if(!r.startsWith("-----BEGIN RSA PUBLIC KEY-----"))throw Error(e);let t=new B({});try{t.setPublicKey(r)}catch(s){throw new A({rsa:r,base64:i},e)}return!0}catch(e){let{message:r}=e;return r}});var x=class{setData(e){e.id&&(this.id=e.id),e.publicKey&&(this.publicKey=e.publicKey)}validate(){return a(this,null,function*(){if(!Number.isInteger(this.id))throw Error("Operator ID should be integer");let e=yield ae(this.publicKey||"");if(e!==!0)throw Error(String(e))})}};y([(0,m.IsNotEmpty)(),(0,m.IsDefined)(),(0,m.IsInt)()],x.prototype,"id",2),y([(0,m.IsNotEmpty)(),(0,m.IsDefined)(),(0,m.IsString)(),(0,m.MinLength)(98)],x.prototype,"publicKey",2);var ne=S(c("web3")),oe=S(c("underscore")),ce=c("js-base64"),k=c("class-validator");var fe=new ne.default,O=class{setData(e){e.publicKeys&&(this.validateArrayOfStrings(e.publicKeys),this.publicKeys=e.publicKeys),e.encryptedKeys&&(this.validateArrayOfStrings(e.encryptedKeys),this.encryptedKeys=e.encryptedKeys)}validate(){return a(this,null,function*(){yield this.validatePublicKeys(),yield this.validateEncryptedKeys()})}validateEncryptedKeys(){return a(this,null,function*(){let e="";try{(this.encryptedKeys||[]).map(r=>{let t=r;t.startsWith("0x")&&(e=t,t=fe.eth.abi.decodeParameter("string",r)),(0,ce.decode)(String(t))})}catch(r){throw Error(`Can not ABI decode shares encrypted key: ${e}. Error: ${String(r)}`)}})}validatePublicKeys(){return a(this,null,function*(){let e="";try{for(let r of this.publicKeys||[])e=r,yield p.deserializeHexStrToPublicKey(r.replace("0x",""))}catch(r){throw Error(`Can not BLS deserialize shares public key: ${e}. Error: ${String(r)}`)}})}validateArrayOfStrings(e){if(!oe.default.isArray(e)||!e.every(t=>typeof t=="string"))throw Error("Keys should be an array of strings")}};y([(0,k.IsArray)(),(0,k.MinLength)(98,{each:!0})],O.prototype,"publicKeys",2),y([(0,k.IsArray)(),(0,k.MinLength)(98,{each:!0})],O.prototype,"encryptedKeys",2);var w=class{constructor(){this.publicKey=null;this.operators=null;this.shares=null}setData(e){if(e.publicKey&&(this.publicKey=e.publicKey),e.operators&&(this.operators=e.operators.map(r=>{let t=new x;return t.setData(r),t})),e.shares){let r=new O;ye.default.isArray(e.shares)?r.setData({publicKeys:e.shares.map(t=>t.publicKey),encryptedKeys:e.shares.map(t=>t.privateKey)}):r.setData(e.shares),this.shares=r}}validate(){return a(this,null,function*(){var e;yield p.init(p.BLS12_381),yield this.validateCounts(),yield(e=this.shares)==null?void 0:e.validate(),yield this.validatePublicKey(),yield this.validateOperators()})}get sharesPublicKeys(){var e;return((e=this.shares)==null?void 0:e.publicKeys)||[]}get sharesEncryptedKeys(){var e;return((e=this.shares)==null?void 0:e.encryptedKeys)||[]}get operatorIds(){var e;return(e=this.operators)!=null&&e.length?this.operators.map(r=>parseInt(String(r.id),10)):[]}get operatorPublicKeys(){var e;return(e=this.operators)!=null&&e.length?this.operators.map(r=>String(r.publicKey)):[]}validatePublicKey(){return a(this,null,function*(){if(!!this.publicKey)try{yield p.deserializeHexStrToPublicKey(this.publicKey.replace("0x",""))}catch(e){throw Error(`Can not BLS deserialize validator public key: ${this.publicKey}. Error: ${String(e)}`)}})}validateCounts(){return a(this,null,function*(){var e,r;if(!(!((e=this.sharesEncryptedKeys)!=null&&e.length)||!((r=this.sharesPublicKeys)!=null&&r.length))&&(this.operatorIds.length!==this.sharesEncryptedKeys.length||this.operatorIds.length!==this.sharesPublicKeys.length||this.operatorIds.length!==this.operatorPublicKeys.length))throw Error("Length of operators and shares should be equal.")})}validateOperators(){return a(this,null,function*(){for(let e of this.operators||[])yield e.validate()})}};y([(0,g.IsOptional)(),(0,g.IsString)(),(0,g.Length)(98,98)],w.prototype,"publicKey",2),y([(0,g.IsOptional)(),(0,g.ValidateNested)({each:!0})],w.prototype,"operators",2),y([(0,g.IsOptional)(),(0,g.ValidateNested)()],w.prototype,"shares",2);var X=S(c("underscore")),E=c("class-validator");var v=class{constructor(){this.readable=null;this.raw=null}setData(e){if(!e===null){this.raw=null,this.readable=null;return}if(X.default.isArray(e)){this.raw=this.toRaw(e),this.readable=this.toReadable(e);return}X.default.isObject(e)&&(e.readable&&(this.readable=e.readable),e.raw&&(this.raw=e.raw))}toRaw(e){return e.join(",")}toReadable(e){return{validatorPublicKey:e[v.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY],operatorIds:e[v.PAYLOAD_INDEX_OPERATOR_IDS],sharePublicKeys:e[v.PAYLOAD_INDEX_SHARE_PUBLIC_KEYS],sharePrivateKey:e[v.PAYLOAD_INDEX_SHARE_PRIVATE_KEYS],ssvAmount:e[v.PAYLOAD_INDEX_SSV_AMOUNT]}}validate(){return a(this,null,function*(){})}},b=v;b.PAYLOAD_INDEX_VALIDATOR_PUBLIC_KEY=0,b.PAYLOAD_INDEX_OPERATOR_IDS=1,b.PAYLOAD_INDEX_SHARE_PUBLIC_KEYS=2,b.PAYLOAD_INDEX_SHARE_PRIVATE_KEYS=3,b.PAYLOAD_INDEX_SSV_AMOUNT=4,y([(0,E.IsOptional)(),(0,E.IsObject)()],b.prototype,"readable",2),y([(0,E.IsOptional)(),(0,E.IsString)()],b.prototype,"raw",2);var _=class{constructor({version:e}){this.byVersion={payload:{[_.VERSION_V2]:b},data:{[_.VERSION_V2]:w}};this.version=e}setPayload(e){return a(this,null,function*(){return yield this.usePayload(e,this.version),this})}setData(e){return a(this,null,function*(){return yield this.useData(e,this.version),this})}static fromData(e){return a(this,null,function*(){typeof e=="string"&&(e=JSON.parse(e));let r=new _({version:e.version});return yield r.setData(e.data),yield r.setPayload(e.payload),r})}usePayload(e,r){return a(this,null,function*(){this.payload=this.payload||this.getByVersion("payload",r),this.payload&&(yield this.payload.setData(e),yield this.validate())})}getByVersion(e,r){if(!this.byVersion[e])throw Error(`"${e}" is unknown entity`);if(!this.byVersion[e][r])throw Error(`"${e}" is not supported in version of key shares: ${r}`);return new this.byVersion[e][r]}useData(e,r){return a(this,null,function*(){!e||(this.data=this.data||this.getByVersion("data",r),this.data&&(yield this.data.setData(e),yield this.validate()))})}validate(){return a(this,null,function*(){var e,r;yield(0,l.validateOrReject)(this).catch(t=>{throw Error(`Key shares file have wrong format. Errors: ${JSON.stringify(t,null,"  ")}`)}),yield(e=this.payload)==null?void 0:e.validate(),yield(r=this.data)==null?void 0:r.validate()})}toString(){return JSON.stringify({version:this.version,data:this.data||null,payload:this.payload||null,createdAt:new Date().toISOString()},null,"  ")}},I=_;I.VERSION_V2="v2",y([(0,l.IsString)(),(0,l.IsDefined)(),(0,l.IsNotEmpty)()],I.prototype,"version",2),y([(0,l.IsOptional)(),(0,l.ValidateNested)()],I.prototype,"data",2),y([(0,l.IsOptional)(),(0,l.ValidateNested)()],I.prototype,"payload",2);})();
